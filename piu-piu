#!/bin/bash
#--------------------------------------------------------------------+
#Color picker, usage: printf ${BLD}${CUR}${RED}${BBLU}"Hello!)"${DEF}|
#-------------------------+--------------------------------+---------+
#       Text color        |       Background color         |         |
#-----------+-------------+--------------+-----------------+         |
# Base color|Lighter shade| Base color   | Lighter shade   |         |
#-----------+-------------+--------------+-----------------+         |
BLK='\e[30m'; blk='\e[90m'; BBLK='\e[40m'; bblk='\e[100m' #| Black   |
RED='\e[31m'; red='\e[91m'; BRED='\e[41m'; bred='\e[101m' #| Red     |
GRN='\e[32m'; grn='\e[92m'; BGRN='\e[42m'; bgrn='\e[102m' #| Green   |
YLW='\e[33m'; ylw='\e[93m'; BYLW='\e[43m'; bylw='\e[103m' #| Yellow  |
BLU='\e[34m'; blu='\e[94m'; BBLU='\e[44m'; bblu='\e[104m' #| Blue    |
MGN='\e[35m'; mgn='\e[95m'; BMGN='\e[45m'; bmgn='\e[105m' #| Magenta |
CYN='\e[36m'; cyn='\e[96m'; BCYN='\e[46m'; bcyn='\e[106m' #| Cyan    |
WHT='\e[37m'; wht='\e[97m'; BWHT='\e[47m'; bwht='\e[107m' #| White   |
#----------------------------------------------------------+---------+
# Effects                                                            |
#--------------------------------------------------------------------+
DEF='\e[0m'   #Default color and effects                             |
BLD='\e[1m'   #Bold\brighter                                         |
DIM='\e[2m'   #Dim\darker                                            |
CUR='\e[3m'   #Italic font                                           |
UND='\e[4m'   #Underline                                             |
INV='\e[7m'   #Inverted                                              |
COF='\e[?25l' #Cursor Off                                            |
CON='\e[?25h' #Cursor On                                             |
#--------------------------------------------------------------------+
# Text positioning, usage: XY 10 10 "Hello World!"                   |
XY   () { printf "\e[${2};${1}H${3}";   } #                          |
#--------------------------------------------------------------------+
# Print line, usage: line - 10 | line -= 20 | line "Hello World!" 20 |
line () { printf %.s"${1}" $(seq ${2}); } #                          |
#--------------------------------------------------------------------+

function start_opt {
#------------------------{ Start opt }------------------------{ description }--------------{ def. values }--------------
  background=true									# background objects visibility				(true)
    tillboss=100									# frags needed to fight with boss			(100)
     bhealth=100									# boss' health								(100)
     enumber=0										# current enemy counter						(0)
     bonuses=("ammo" "life" "ammo" "gunup" "ammo")	# bonuses, more ammo, less life ang gunup
      goback=false									# need 4 boss movement
       enmax=10										# max number of akiens						(10)
       month=$(date +'%m')							# get current month
       frags=0										# frags counter								(0)
        life=3										# life counter								(3)
        ammo=100									# ammo counter								(100)
        FPSL=100									# lower FPS initial value					(100)
        FPSM=0										# maximum FPS initial value					(0)
        FPSC=0										# FPS counter								(0)
         rnd=10										# random seed 4 bonuses						(10)
         spd=0.0001									# game\read speed							(0.0001)
         DHC=${BLK}									# default hero color						($BLK)
         DSC=${RED}									# default symbol color						($red)
         DHS=★										# default symbol							(★)
         OBJ=()										# start obj array
         PIU=()										# start piu array
          BY=$[$(tput lines) / 2]					# boss start Y
          BX=$[$(tput  cols) + 1]					# boss start X
          BC=0										# boss' sprite cutter
          LX=1										# grass X counter
           X=1										# hero X									(1)
           Y=1										# hero Y									(1)
           L=0										# sprites animation counter
           J=0										# boss' bullet animation counter
           K=0										# boss' fire rate counter
           S=0										# Sun animation counter
           G=1										# gun 										(1)(max 5)

[ -e piu.conf ] && . piu.conf						# load start conf from file
}; start_opt
#------------------------{ Messages }-----------------------------------------------------------------------------------
        help=(                  '                   ^     '
		                  "                   ${RED}W${DEF}     "
		      "${BLD}Control with:${DEF}  < ${RED}A S D${DEF} > "
		                        '                   v     '
		      ''
		      "${BLD}Shoot\select with:${DEF} ${YLW}P ${BLD}${red}-=${GRN}>${DEF} ")

        lose=('                            '
  ${BLD}${red}'  ____    _    __  __ _____ '${DEF}
        ${red}' / ___|  / \  |  \/  | ____|'${DEF}
        ${red}'| | __  / _ \ | |\/| |  _|  '${DEF}
        ${RED}'| |_\ \/ ___ \| |  | | |___ '${DEF}
  ${DIM}${RED}' \____/_/   \_\_|__|_|_____|'${DEF}
  ${BLD}${red}'  / _ \ \   / / ____|  _ \  '${DEF}
        ${red}' | | | \ \ / /|  _| | |_) | '${DEF}
        ${RED}' | |_| |\ V / | |___|  _ <  '${DEF}
  ${DIM}${RED}'  \___/  \_/  |_____|_| \_| '${DEF})

         win=('                           '
  ${BLD}${grn}'__        ______ _    _    '${DEF}
        ${grn}'\ \      / /____| |  | |   '${DEF}
        ${grn}' \ \ /\ / /  _| | |  | |   '${DEF}
        ${GRN}'  \ V  V /| |___| |__| |__ '${DEF}
  ${DIM}${GRN}' __\_/\_/_|_____|____|____|'${DEF}
  ${BLD}${grn}'|  _ \ / _ \| \ | | ____| |'${DEF}
        ${grn}'| | | | | | |  \| |  _| | |'${DEF}
        ${GRN}'| |_| | |_| | |\  | |___|_|'${DEF}
  ${DIM}${GRN}'|____/ \___/|_| \_|_____(_)'${DEF})

#------------------------{ Sprites }-------------------------------------------------------------------------------------
case $month in	0[1-4]|12)	SKY=${DEF}${bwht}				# winter & early spring sky
							LND=${DEF}${BLD}${WHT}${BWHT}	# winter & early spring land
							CLD=30							# winter & early spring clouds rnd
							TRE=50;;						# winter & early spring trees rnd

				0[5-8]   )	SKY=${DEF}${bcyn}				# late spring & summer sky
							LND=${DEF}${DIM}${GRN}${bgrn}	# late spring & summer land
							CLD=50							# late spring & summer clouds rnd
							TRE=20;;						# late spring & summer trees rnd

				09|1[0-1])	SKY=${DEF}${BCYN}				# autumn sky
							LND=${DEF}${DIM}${YLW}${BGRN}	# autumn land
							CLD=20							# autumn clouds rnd
							TRE=50;;						# autumn trees rnd
esac

         gun=(- - = ≡ ≣ 𝄚)

       grass=(│ ' ' ║ ' ' ░ ' ' ▒ ' ' ▓ ' ' █) # grass types

#------------------------{ Cycle slow }----------------------------------------------------------------------------------
         big=(' O   O '
		      'O   O  '
              '   O   '
              '  O   O')

       small=('o  '
              '   '
              '  o'
              ' o ')

#------------------------{ Cycle fast }----------------------------------------------------------------------------------
        big2=(${RED}' O   O '${SKY}
		      ${RED}'O   O  '${SKY}
              ${RED}"   ${BLD}O   "${SKY}
              ${RED}'  O   O'${SKY})

        big3=(${BLU}'  O   O'${SKY}
              ${BLU}"   ${BLD}O   "${SKY}
		      ${BLU}'O   O  '${SKY}
              ${BLU}' O   O '${SKY})

      small2=(${YLW}" ${BLD}o "${SKY}
              ${YLW}'  o'${SKY}
              ${YLW}'   '${SKY}
              ${YLW}'o  '${SKY})

#------------------------{ Shoots }--------------------------------------------------------------------------------------
       shoot=("$SKY ${RED}-${SKY}${BLD}${GRN}>${SKY}"
              "${BLD}${red}-=${SKY}${GRN}>${SKY}"
              "${red}=-${SKY}${BLD}${GRN}>${SKY}"
              "${RED}-${SKY} ${GRN}>${SKY}")

      bshoot=('█▓▒░ '
              '▓▒░▒ '
              '▒░▒▓ '
              '░▒▓█ '
              '▒▓█▓ '
              '▓█▓▒ '); bshootH=1; bshootW=4

 bshoot_color=("$ylw $ylw $ylw $ylw")

function sprite_bfire {

       hight=$bshootH
       width=$bshootW
       color=("${bshoot_color[@]}")
	  target=("$OX $[$OY+1]" "$[$OX+1] $OY")

      sprite="\e[$OY;${OX}H$ylw${bshoot[$J]}$SKY "
     sprite2="${bshoot[$J]} "
}

#------------------------{ Bonuses }-------------------------------------------------------------------------------------
       ammob=('-=> '
              '-=> '
              '-=> '); ammobH=${#ammob[*]}; ammobW=${#ammob[1]}

         CM1=$BLD$red; CM2=$SKY$GRN
 ammob_color=("$CM1 $CM1 $CM2 $SKY"
              "$CM1 $CM1 $CM2 $SKY"
              "$CM1 $CM1 $CM2 $SKY")

function sprite_ammob {

       hight=$ammobH
       width=$ammobW
       color=("${ammob_color[@]}")
	  target=("$OX $OY" "$OX $[$OY+1]" "$OX $[$OY+2]")

      sprite=("\e[$OY;${OX}H$BLD$red-=$SKY$GRN>$SKY "
         "\e[$[$OY+1];${OX}H$BLD$red-=$SKY$GRN>$SKY "
         "\e[$[$OY+2];${OX}H$BLD$red-=$SKY$GRN>$SKY ")

     sprite2=("${ammob[@]}")
}

       lifep=('/V\ '
              '\ / '
              ' V  '); lifepH=${#lifep[*]}; lifepW=${#lifep[1]}

 lifep_color=("$RED $RED $RED $SKY"
              "$RED $RED $RED $SKY"
              "$SKY $RED $SKY $SKY")

function sprite_lifep {

       hight=$lifepH
       width=$lifepW
       color=("${lifep_color[@]}")
	  target=("$OX $OY" "$OX $[$OY+1]" "$OX $[$OY+2]")

      sprite=("\e[$OY;${OX}H"$SKY$RED'/V\ '$SKY
         "\e[$[$OY+1];${OX}H"$SKY$RED'\ / '$SKY
       "\e[$[$OY+2];$[$OX+1]H"$SKY$RED'V '$SKY)

     sprite2=("${lifep[@]}")
}

function sprite_gunup {

       hight=3
       width=5
	  target=("$OX $OY"      "$OX $[$OY+1]"      "$OX $[$OY+2]"
              "$[$OX+1] $OY" "$[$OX+1] $[$OY+1]" "$[$OX+1] $[$OY+2]")

	case ${G} in

		1) sprite=("\e[$OY;${OX}H$BLK||$blk--$SKY "
		      "\e[$[$OY+1];${OX}H$BLK||$SKY "
		      "\e[$[$OY+2];${OX}H$BLK||$blk--$SKY ")

          sprite2=('||-- '
		           '|| '
		           '||-- ')

            color=("$BLK $BLK $blk $blk $SKY"
                   "$BLK $BLK $SKY"
                   "$BLK $BLK $blk $blk $SKY");;

		2) sprite=("\e[$OY;${OX}H$BLK||$blk--$SKY "
		      "\e[$[$OY+1];${OX}H$BLK||$blk--$SKY "
		      "\e[$[$OY+2];${OX}H$BLK||$blk--$SKY ")

          sprite2=('||-- '
		           '||-- '
		           '||-- ')

            color=("$BLK $BLK $blk $blk $SKY"
                   "$BLK $BLK $blk $blk $SKY"
                   "$BLK $BLK $blk $blk $SKY");;

		3) sprite=("\e[$OY;${OX}H$BLK||$blk==$SKY "
		      "\e[$[$OY+1];${OX}H$BLK||$SKY "
		      "\e[$[$OY+2];${OX}H$BLK||$blk==$SKY ")

          sprite2=('||== '
		           '|| '
		           '||== ')

            color=("$BLK $BLK $blk $blk $SKY"
                   "$BLK $BLK $SKY"
                   "$BLK $BLK $blk $blk $SKY");;

		*) sprite=("\e[$OY;${OX}H$BLK||$blk==$SKY "
		      "\e[$[$OY+1];${OX}H$BLK||$blk--$SKY "
		      "\e[$[$OY+2];${OX}H$BLK||$blk==$SKY ")

          sprite2=('||== '
		           '||-- '
		           '||== ')

            color=("$BLK $BLK $blk $blk $SKY"
                   "$BLK $BLK $blk $blk $SKY"
                   "$BLK $BLK $blk $blk $SKY");; esac
}

#------------------------{ Clouds }--------------------------------------------------------------------------------------
      cloud1=(' ,-., '
              '(    ) '
              ' `+-` '); cloud1H=${#cloud1[*]}; cloud1W=${#cloud1[1]}

	case $month in	0[1-4]|12) C1C=$DIM$CYN;; # winter & early spring
					0[5-8]   ) C1C=$DIM$WHT;; # late spring & summer
					09|1[0-1]) C1C=$blk    ;; # autumn
	esac

cloud1_color=("$SKY $C1C $C1C $C1C $C1C $SKY"
              "$C1C $SKY $SKY $SKY $SKY $C1C $SKY"
              "$SKY $C1C $C1C $C1C $C1C $SKY")

function sprite_cloud1 {

       hight=$cloud1H
       width=$cloud1W
       color=("${cloud1_color[@]}")

      sprite=("\e[$OY;$[$OX+1]H"$SKY$C1C',-., '$SKY
           "\e[$[$OY+1];${OX}H"$SKY$C1C'(    ) '$SKY
         "\e[$[$OY+2];$[$OX+1]H"$SKY$C1C'`+-` '$SKY)

     sprite2=("${cloud1[@]}")
}

      cloud2=(' ,-._., '
              '(      ) '
              ' `-...` '); cloud2H=${#cloud2[*]}; cloud2W=${#cloud2[1]}

	case $month in	0[1-4]|12) C2C=$CYN;; # winter & early spring
					0[5-8]   ) C2C=$WHT;; # late spring & summer
					09|1[0-1]) C2C=$BLK;; # autumn
	esac

         CM1=$SKY$DIM
cloud2_color=("$SKY $C2C $C2C $C2C $C2C $C2C $C2C $SKY"
              "$C2C $SKY $SKY $SKY $SKY $SKY $SKY $C2C $SKY"
              "$SKY $C2C $C2C $C2C $C2C $C2C $C2C $SKY")

function sprite_cloud2 {

       hight=$cloud2H
       width=$cloud2W
       color=("${cloud2_color[@]}")

      sprite=("\e[$OY;$[$OX+1]H"$SKY$C2C',-._., '$SKY
           "\e[$[$OY+1];${OX}H"$SKY$C2C'(      ) '$SKY
         "\e[$[$OY+2];$[$OX+1]H"$SKY$C2C'`-...` '$SKY)

     sprite2=("${cloud2[@]}")
}

      cloud3=(' ,-"`.-"`. '
              '(         ) '
              ' `--.....` '); cloud3H=${#cloud3[*]}; cloud3W=${#cloud3[1]}

	case $month in	0[1-4]|12) C3C=$BLD$CYN;; # winter & early spring
					0[5-8]   ) C3C=$BLD$WHT;; # late spring & summer
					09|1[0-1]) C3C=$DIM$BLK;; # autumn
	esac

cloud3_color=("$SKY $C3C $C3C $C3C $C3C $C3C $C3C $C3C $C3C $C3C $SKY"
              "$C3C $SKY $SKY $SKY $SKY $SKY $SKY $SKY $SKY $SKY $C3C $SKY" 
              "$SKY $C3C $C3C $C3C $C3C $C3C $C3C $C3C $C3C $C3C $SKY")

function sprite_cloud3 {

       hight=$cloud3H
       width=$cloud3W
       color=("${cloud3_color[@]}")

      sprite=("\e[$OY;$[$OX+1]H"$SKY$C3C',-"`.-"`. '$SKY
           "\e[$[$OY+1];${OX}H"$SKY$C3C'(         ) '$SKY
         "\e[$[$OY+2];$[$OX+1]H"$SKY$C3C'`--.....` '$SKY)

     sprite2=("${cloud3[@]}")
}

#------------------------{ Trees }---------------------------------------------------------------------------------------
       tree1=(' _ '
              '/ \ '
              '\|/ '
              ' | '); tree1H=${#tree1[*]}; tree1W=${#tree1[1]}

	case $month in	0[1-4]|12) T1C=$DIM$WHT;; # winter & early spring
					0[5-8]   ) T1C=$DIM$GRN;; # late spring & summer
					09|1[0-1]) T1C=$DIM$YLW;; # autumn
	esac

         CM1=$SKY$DIM
 tree1_color=("$T1C $T1C $SKY"
              "$T1C $T1C $T1C $SKY"
              "$T1C $CM1 $T1C $SKY"
              "$SKY $CM1 $SKY")

function sprite_tree1 {

       hight=$tree1H
       width=$tree1W
       color=("${tree1_color[@]}")

      sprite=("\e[$OY;$[$OX+1]H"$SKY$T1C'_  '$SKY
           "\e[$[$OY+1];${OX}H"$SKY$T1C'/ \ '$SKY
           "\e[$[$OY+2];${OX}H"$SKY$T1C'\\'$CM1'|'$T1C'/ '$SKY
         "\e[$[$OY+3];$[$OX+1]H"$SKY$CM1'| '$SKY)


     sprite2=("${tree1[@]}")
}

       tree2=(' _._ '
              '/   \ '
              '\ | / '
              ' \║/\ '
              '  ║_/ '
              '  ║ '); tree2H=${#tree2[*]}; tree2W=${#tree2[1]}

	case $month in	0[1-4]|12) T2C=$WHT;; # winter & early spring
					0[5-8]   ) T2C=$GRN;; # late spring & summer
					09|1[0-1]) T2C=$YLW;; # autumn
	esac

         CM1=$SKY$T2C
 tree2_color=("$T2C $T2C $T2C $T2C $SKY"
              "$T2C $T2C $T2C $T2C $T2C $SKY"
              "$T2C $T2C $blk $CM1 $T2C $SKY"
              "$SKY $T2C $blk $CM1 $T2C $SKY"
              "$SKY $SKY $blk $CM1 $T2C $SKY"
              "$SKY $SKY $blk $CM1 $SKY")

function sprite_tree2 {

       hight=$tree2H
       width=$tree2W
       color=("${tree2_color[@]}")

      sprite=("\e[$OY;$[$OX+1]H"$SKY$T2C'_._  '$SKY
           "\e[$[$OY+1];${OX}H"$SKY$T2C'/   \ '$SKY
           "\e[$[$OY+2];${OX}H"$SKY$T2C'\\'$blk' | '$CM1'/ '$SKY
         "\e[$[$OY+3];$[$OX+1]H"$SKY$T2C'\\'$blk'║'$CM1'/\ '$SKY
          "\e[$[$OY+4];$[$OX+2]H"$SKY$blk'║'$T2C'_/ '$SKY
          "\e[$[$OY+5];$[$OX+2]H"$SKY$blk'║ '$SKY)

     sprite2=("${tree2[@]}")
}

       tree3=('   _._ '
              '  /   \ '
              ' _\ | / '
              '/  \║/__ '
              '\_\/║/  \ '
              '   \║|/_/ '
              '    ║/ '
              '    ║ '
              '    ║ '); tree3H=${#tree3[*]}; tree3W=${#tree3[5]}

	case $month in	0[1-4]|12) T3C=$BLD$cyn;; # winter & early spring
					0[5-8]   ) T3C=$BLD$GRN;; # late spring & summer
					09|1[0-1]) T3C=$DIM$red;; # autumn
	esac

         CM1=$SKY$BLK
 tree3_color=("$SKY $SKY $SKY $T3C $T3C $T3C $SKY"
              "$SKY $SKY $T3C $SKY $SKY $SKY $T3C $SKY"
              "$SKY $T3C $T3C $SKY $CM1 $SKY $T3C $SKY"
              "$T3C $SKY $SKY $T3C $CM1 $T3C $T3C $T3C $SKY"
              "$T3C $T3C $CM1 $T3C $CM1 $T3C $SKY $SKY $T3C $SKY"
              "$SKY $SKY $SKY $CM1 $CM1 $T3C $CM1 $T3C $T3C $SKY"
              "$SKY $SKY $SKY $SKY $CM1 $CM1 $SKY"
              "$SKY $SKY $SKY $SKY $CM1 $SKY"
              "$SKY $SKY $SKY $SKY $CM1 $SKY")

function sprite_tree3 {

       hight=$tree3H
       width=$tree3W
       color=("${tree3_color[@]}")

      sprite=("\e[$OY;$[$OX+3]H"$SKY$T3C'_._ '$SKY
        "\e[$[$OY+1];$[$OX+2]H"$SKY$T3C'/   \ '$SKY
       "\e[$[$OY+2];$[$OX+1]H"$SKY$T3C'_\ '$CM1'|'$T3C' / '$SKY
       "\e[$[$OY+3];${OX}H"$SKY$T3C'/  \\'$CM1'║'$T3C'/__ '$SKY
       "\e[$[$OY+4];${OX}H"$SKY$T3C'\_'$CM1'\\'$T3C'/'$CM1'║'$T3C'/  \ '$SKY
         "\e[$[$OY+5];$[$OX+3]H"$SKY$BLK'\║'$T3C'|'$CM1'/'$T3C'_/ '$SKY
          "\e[$[$OY+6];$[$OX+4]H"$SKY$BLK'║/ '$SKY
          "\e[$[$OY+7];$[$OX+4]H"$SKY$BLK'║ '$SKY
          "\e[$[$OY+8];$[$OX+4]H"$SKY$BLK'║ '$SKY)

     sprite2=("${tree3[@]}")
}

#------------------------{ Aliens slow }---------------------------------------------------------------------------------
       alien=(' ___ '
              '(   ) '
              ' `¯´ '); alienH=${#alien[*]}; alienW=${#alien[1]}

         CM1=$DIM$BLK; CM2=$BLD$BLK
 alien_color=("$SKY $CM1 $CM2 $CM1 $SKY"
              "$CM1 $red $red $red $CM1 $SKY"
              "$SKY $CM1 $CM1 $CM1 $SKY")

function sprite_alien {

       hight=$alienH
       width=$alienW
       color=("${alien_color[@]}")
	  target=("$OX $[$OY+1]" "$[$OX+1] $[$OY+1]")

         CM1=$SKY$DIM$BLK; CM2=$BLD$BLK
	  sprite=("\e[$OY;$[$OX+1]H${CM1}_${CM2}_${CM1}_$SKY "
              "\e[$[$OY+1];${OX}H${CM1}(${red}${small[$L]}${CM1})${SKY} "
              "\e[$[$OY+2];$[$OX+1]H"${CM1}'`¯´ '${SKY})

     sprite2=(' ___ '
              "(${small[$L]}) "
              ' `¯´ ')
}

        boss=('         '
              '     ___   '
              '   _/   \_  '
              '  /       \  '
              ' (         ) '
              '  `¯¯---¯¯´  '
              '            '); bossH=${#boss[*]}; bossW=${#boss[4]}


         CM1=$DIM$BLK; CM2=$BLD$BLK; CM3=$SKY$BLK; CM4=$SKY$BLU; CM5=$BLD$YLW; CM6=$BLD$RED; CM7=$BLD$BLU; CM8=$SKY$YLW; CM9=$SKY$RED
  boss_color=("$SKY" #                   center point
              "$SKY $SKY $SKY $SKY $SKY $CM1 $CM2 $CM1 $SKY"
              "$SKY $SKY $SKY $CM1 $CM1 $YLW $CM5 $CM8 $CM1 $CM1 $SKY"
              "$SKY $SKY $CM1 $RED $RED $RED $CM6 $CM9 $RED $RED $CM1 $SKY"
              "$SKY $CM1 $SKY $BLU $BLU $BLU $CM7 $CM4 $BLU $BLU $SKY $CM1 $SKY"
              "$SKY $CM1 $CM1 $CM1 $CM1 $CM1 $CM1 $CM1 $CM1 $CM1 $CM1 $SKY")

function sprite_boss {

       hight=$bossH
       width=$bossW
       color=("${boss_color[@]}")
	  target=("$[$OX+5] $[$OY+2]" "$[$OX+3] $[$OY+3]" "$[$OX+2] $[$OY+4]")
          EX=$[$OX+2]; EY=$[$OY+3]
          YY=$[$Y-1]

		# Boss fire
		[[ $OY -eq $YY && $K -eq 0 ]] && OBJ+=("$[$OX - 4] $[$OY + 4] 0 bfire")

		# Boss move
		[[ $OY -lt $YY                               ]] && ((OY++))
		[[ $OY -gt $YY                               ]] && ((OY--))
		[[ $OX -gt $[$endx / 2] && $goback = 'false' ]] && ((OX--)) || goback=true
		[[ $OX -lt $bossendx    && $goback = 'true'  ]] && ((OX++)) || goback=false

         CM1=$DIM$BLK; CM2=$BLD$BLK
      sprite=("\e[$OY;$[$OX+4]H${SKY}     "
       "\e[$[$OY+1];$[$OX+2]H   ${CM1}_${CM2}_${CM1}_${SKY}   "
      "\e[$[$OY+2];$[$OX+1]H  ${CM1}_/${small2[$L]}${CM1}\_${SKY}  "
        "\e[$[$OY+3];${OX}H  ${CM1}/${big2[$L]}"${CM1}'\\'"${SKY}  "
        "\e[$[$OY+4];${OX}H ${CM1}( ${big3[$L]} ${CM1})${SKY} "
      "\e[$[$OY+5];${OX}H  ${CM1}"'`¯¯---¯¯´  '
      "\e[$[$OY+6];$[$OX+1]H${SKY}           ")

     sprite2=('         '
              '     ___   '
              "   _/${small[$L]}\_  "
              "  /${big[$L]}\  "
              " ( ${big[$L]} ) "
              '  `¯¯---¯¯´  '
              '            ')

	((cuter++)); OBJ[$i]="$OX $OY $cuter $type"
}

#------------------------{ Animations }---------------------------------------------------------------------------------
        boom=('.-.'
             '(   )'
              '`-`'

             ', - .'
            '(     )'
             '. _ .'

              '`  "'
           '(       )'
             '_ _ .'); boomN=${#boom[@]}; boomC=3

function sprite_boom {

	[[ $cuter -gt $boomN ]] && { erase_obj $i $boomC; return; }

        boom=(  "\e[$OY;$[$OX+3]H${red}.-."${SKY}
          "\e[$[$OY+1];$[$OX+2]H${red}(   )"${SKY}
         "\e[$[$OY+2];$[$OX+3]H${red}"'`-`'${SKY}

               "\e[$OY;$[$OX+2]H${RED}, - ."${SKY}
         "\e[$[$OY+1];$[$OX+1]H${RED}(     )"${SKY}
          "\e[$[$OY+2];$[$OX+2]H${RED}. _ ."${SKY}

        "\e[$OY;$[$OX+2]H${DIM}${RED}"'`  "'${SKY}
     "\e[$[$OY+1];${OX}H${DIM}${RED}(       )"${SKY}
    "\e[$[$OY+2];$[$OX+2]H${DIM}${RED}_ _ ."${SKY})

    printf "${boom[*]:$cuter:$boomC}"
    [[ $E -eq 0 ]] && { ((cuter+=${boomC})); OBJ[$i]="$OX $OY $cuter boom"; }
}

         Sun=('       ___ |       '
              '---````    \       '
              '           _`.     '
              '        ../   `..__'
              '     ../        /  '
              '    /          /   '
              '              /    '
              '              /    '
              '             /     '

              '_...---``  |       '
              '        _.-\       '
              '   _.--`    `.     '
              ' -`          ,`..__'
              '           ,`     |'
              '         ,`       |'
              '       _`        | '
              '                 | '
              '                 | '

              '     _...--|       '
              '..--`      \       '
              '         .. `.     '
              '     _.-`     `..__'
              '  ..`         .`   '
              '             /     '
              '            /      '
              '          .`       '
              '         `         '); SunN=${#Sun[@]}; SunC=9

function sprite_Sun {

         Sun=("\e[1;${Sunsendx}H"$SKY$YLW'       ___ |       '
              "\e[2;${Sunsendx}H"$SKY$YLW'---````    \       '
              "\e[3;${Sunsendx}H"$SKY$YLW'           _`.     '
          "\e[4;${Sunsendx}H"$SKY$BLD$YLW'        ../   `..__'
              "\e[5;${Sunsendx}H"$SKY$YLW'     ../        /  '
              "\e[6;${Sunsendx}H"$SKY$YLW'    /          /   '
          "\e[7;${Sunsendx}H"$SKY$BLD$YLW'              /    '
              "\e[8;${Sunsendx}H"$SKY$YLW'              /    '
              "\e[9;${Sunsendx}H"$SKY$YLW'             /     '

              "\e[1;${Sunsendx}H"$SKY$YLW'_...---``  |       '
          "\e[2;${Sunsendx}H"$SKY$BLD$YLW'        _.-\       '
              "\e[3;${Sunsendx}H"$SKY$YLW'   _.--`    `.     '
              "\e[4;${Sunsendx}H"$SKY$YLW' -`          ,`..__'
          "\e[5;${Sunsendx}H"$SKY$BLD$YLW'           ,`     |'
              "\e[6;${Sunsendx}H"$SKY$YLW'         ,`       |'
              "\e[7;${Sunsendx}H"$SKY$YLW'       _`        | '
          "\e[8;${Sunsendx}H"$SKY$BLD$YLW'                 | '
              "\e[9;${Sunsendx}H"$SKY$YLW'                 | '

          "\e[1;${Sunsendx}H"$SKY$BLD$YLW'     _...--|       '
              "\e[2;${Sunsendx}H"$SKY$YLW'..--`      \       '
          "\e[3;${Sunsendx}H"$SKY$BLD$YLW'         .. `.     '
              "\e[4;${Sunsendx}H"$SKY$YLW'     _.-`     `..__'
              "\e[5;${Sunsendx}H"$SKY$YLW'  ..`         .`   '
          "\e[6;${Sunsendx}H"$SKY$BLD$YLW'             /     '
              "\e[7;${Sunsendx}H"$SKY$YLW'            /      '
          "\e[8;${Sunsendx}H"$SKY$BLD$YLW'          .`       '
              "\e[9;${Sunsendx}H"$SKY$YLW'         `         ')

    [[ $Q -eq 0 ]] && printf "${Sun[*]:$S:$SunC}"
}

function sprite_hero {

         CM4=$DIM$HC; CM5=$SKY$HC; CM6=$BLD$HC; CM7=$SKY$SC$HS$HC$BLD
         CM8=$DIM$UND; CM9=$SKY$HC$BLD

      sprite=(     "\e[$Y;${X}H"${SKY}'    '
              "\e[$[$Y+1];${X}H"${CM5}' __      '${SKY}
              "\e[$[$Y+2];${X}H"${CM4}" |${CM7}〵${CM5}____  "${SKY}
              "\e[$[$Y+3];${X}H"${CM4}"  \_| ${CM6}/${CM8} °${CM9})${blk}${gun[$G]}${SKY} "
              "\e[$[$Y+4];${X}H"${CM4}"    |${BLD}/     "${SKY}
              "\e[$[$Y+5];${X}H"${SKY}'       ')

	printf "${sprite[*]}"
}

#------------------------{ Intro }--------------------------------------------------------------------------------------
           D=$DEF; C1=$BLU; C2=$RED; C3=$YLW; C4=$red; C5=$BLD$YLW; C6=$BLD$GRN; C7=$blu; C8=$BLD$RED

				#   ░   ░░░ ░░     ░  ░░      ░░  ░░ ░
				# ░   ░  ▒██████ ░▒██████ ▒██░  ▒██
				#   ░ ░░▒▓██ ▒▓██ ▓▓▓██▓ ▒▓██ ░▒▓██░░ ░
				#░ ░ ░░▒▓██ ▒▓██ ▒▒▒▓██ ░▒▓██░ ▒▓██░
				#      ▒▓██████░ ░▒▓██ ░▒▓██ ░▒▓██░░ ░ ░
				#  ░  ▒▓██▓▓▓▓  ░ ▒▓██░ ▒▓██░░▒▓██ ░
				#   ▒▓████▒▒▒░ ░ ▓██████ ▒▓██████░░ ░
				#░ ░▒▓▓▓▓ ░ ░░▒▓▓▓▓▓▓ ░ ▒▓▓▓▓▓░
				# ░ ▒▒ ░ ░ ░ ░▒▒▒▒▒▒ ░ ░░▒▒▒▒░  ░

         piu=(	"$C1   " "░  "    " ░░"    "░ ░" "░  " "   " "░  " "░░ " "   " "  ░" "░  " "░░ " "░$D  " "   "
				"$C1 ░ " "  ░" "  $C2▒" "$C3███" "███" " $C1░$C2▒" "$C3███" "███" " $C2▒$C3█" "█$C1░ " " $C2▒$C3█" "█$D  " "   " "   "
				"$C1   " "░ ░" "░$C2▒$C4▓" "$C3██ " "$C2▒$C4▓$C3█" "█ $C4▓" "▓▓$C3█" "█$C4▓ " "$C1▒$C4▓$C3█" "█ $C1░" "$C2▒$C4▓$C3█" "█$C1░░" " ░$D " "   "
				"$C1░ ░" " ░░" "$C2▒$C4▓$C3█" "█ $C2▒" "$C4▓$C3██" " $C2▒▒" "▒$C4▓$C3█" "█ $C2░" "▒$C4▓$C3█" "█$C1░ " "$C2▒$C4▓$C3█" "█$C1░$D " "   " "   "
				"$C1   " "   " "$C2▒$C4▓$C5█" "███" "██$C1░" " ░$C2▒" "$C4▓$C3██" " $C1░$C2▒" "$C4▓$C3██" " $C1░$C2▒" "$C4▓$C3██" "$C1░░ " "░ ░$D" "   "
				"$C1  ░" "  $C2▒" "$C4▓$C3██" "$C4▓▓▓" "▓  " "$C1░ $C2▒" "$C4▓$C3██" "$C1░ $C2▒" "$C4▓$C3██" "$C1░░$C2▒" "$C4▓$C3██" " $C1░$D " "   " "   "
				"$C2   " "▒$C4▓$C3█" "███" "$C2▒▒▒" "$C1░ ░" " $C4▓$C3█" "███" "██ " "$C1▒$C4▓$C3█" "███" "██$C1░" "░ ░$D" "   " "   "
				"$C1░ ░" "$C2▒$C4▓▓" "▓▓ " "$C1░ ░" "░$C2▒$C4▓" "▓▓▓" "▓▓ " "$C1░ $C2▒" "$C4▓▓▓" "▓▓$C1░$D" "   " "   " "   " "   "
				"$C1 ░ " "▒▒ " "░ ░" " ░ " "░▒▒" "▒▒▒" "▒ ░" " ░░" "▒▒▒" "▒░ " " ░ " "   " "   " "$D   "); piuN=${#piu[*]}; piuC=14

				#          ░░ ▒▒███░
				#     ░░░ ▒████ ▒▓███░
				# ░ ▒████▒▓▓▓▓ ░░▒▓▓███ ░░ ░
				#░ ▒▓▓▓▓ ▒████░▒▓███░░
				# ▒ ▒▒  ▒▓▓▓▓▒▓███░
				#    ░░░ ▒▒▒ ░░▒▒░

         arr=(	"   " "   " "   " "   " " $C7░░" " $C3▒▒" "$C6███" "$C7░$D  " ""    ""
				"   " "   " "  $C7░" "░░ " "$C2▒$C8██" "██ " "$C7▒$C3▓$C6█" "██$C7░$D" ""    ""
				"   " " $C7░ " "▒$C8██" "██$D$C2▒" "$C3▓▓▓" "▓ $C7░" "░$C7▒$C3▓" "▓$C6██" "█ $C7░" "░ ░$D"
				"   " "$C7░ $C2▒" "$C3▓▓▓" "▓ $C2▒" "$C8███" "█$D$C7░$C3▒" "$C3▓$C6██" "█$C7░░$D" "   " ""
				"   " " $C7▒ " "▒▒ " " $C2▒$C3▓" "▓▓▓" "$C7▒$C3▓$C6█" "██$C7░$D" "   " ""    ""
				"   " "   " " $C7░░" "░ ▒" "▒▒ " "░░▒" "▒░$D " "   " ""    ""); arrN=${#arr[*]}; arrC=10

#------------------------{ Functions }-----------------------------------------------------------------------------------
function cut_in () { spr=()

	for ((h=0; h<$hight; h++)); do
		for ((c=0; c<$cuter; c++)); do
			color2=(${color[$h]}); symbol=${sprite2[$h]:$c:1}
			spr[$h]+="${color2[$c]}"${symbol//'\'/'\\'}
		done
		sprite[$h]="$SKY\e[$[$OY+$h];${OX}H""${spr[$h]}"
	done
}

function cut_out () { spr=()

	for ((h=0; h<$hight; h++)); do
		for ((w=$[1-$OX]; w<$width; w++)); do
			color2=(${color[$h]}); symbol=${sprite2[$h]:$w:1}
			spr[$h]+="${color2[$w]}"${symbol//'\'/'\\'}
		done
		sprite[$h]="$SKY\e[$[$OY+$h];1H${spr[$h]}"
	done
}

function get_dimensions {
    size=($(stty size))
    endx=${size[1]}
    endy=${size[0]}
bullendx=$[$endx - 4 ]
heroendx=$[$endx - 12]
heroendy=$[$endy - 7 ]
enmyendy=$[$endy - 7 ]
bossendx=$[$endx - 11]
bossendy=$[$endy - 6 ]
bosshbar=$[$endx - 10]
tre1endy=$[$endy - 6 ]
tre2endy=$[$endy - 8 ]
tre3endy=$[$endy - 11]
lineendy=$[$endy - 2 ]
Sunsendx=$[$endx - 18]
}

function default { HC=${DHC}; SC=${DSC}; HS=${DHS}; }
function bye () { stty echo; printf "${CON}${DEF}"; clear; ls --color=auto; exit $1; }
function remove_obj () { unset OBJ[$1]; OBJ=("${OBJ[@]}"); ((NO--)); }
function remove_piu () { unset PIU[$1]; PIU=("${PIU[@]}"); ((NP--)); XY $PX       $PY "$SKY   "; }
function erase_obj  () { remove_obj $1; for (( k=0; k<$2; k++ )); do XY $OX $[$OY+$k] "$SKY         "; done; }

function mess () { XY 1 1 ${DEF}; clear

	function print {
		x=$[$endx / 2 - ${#sprite} / 2]
		for (( i=0; i<${#sprite[*]}; i++ )); do XY ${x} $[$endy / 2 - 5 + $i] "${sprite[$i]}"; done
	}

	case $1 in
		"win" )	sprite=("${win[@]}") ; print; XY 0 ${endy}; sleep 3; clear; start_opt; main_menu; fill_screen;;
		"lose")	sprite=("${lose[@]}"); print; XY 0 ${endy}; sleep 3; clear; start_opt; main_menu; fill_screen;;
		"help")	sprite=("${help[@]}"); print;;
	esac
}

function left () { N=$1; C=$2

		# move
		[ $OX -ge $end ] && {

			((OX-=3)); [ $cuter -ne $C ] && ((cuter++))

			for ((j=0; j<$N; j+=$C)); do

				line=("${sprite[@]:$j:$cuter}"); YY=$[$OY+$j/$C]; spr=
				for part in "${line[@]}"; do spr+="${part}"; done; XY $OX $YY "${spr}"

			done; OBJ[$i]="$OX $OY $cuter $end $type $pause"
		} || { remove_obj $i; ((Q++)); OBJ+=("${scenario[$Q]}"); }
}

function right () { N=$1; C=$2

		# move
		[ $OX -le $end ] && {

			[ $cuter -ne $C ] && ((cuter++)) || ((OX+=3))

			for ((j=0; j<$N; j+=$C)); do

				line=("${sprite[@]:$j:$C}"); YY=$[$OY+$j/$C]; spr=
				for ((k=$[$C-$cuter]; k<$C; k++)); do spr+="${line[k]}"; done; XY $OX $YY "${spr}"

			done; OBJ[$i]="$OX $OY $cuter $end $type $pause"
		} || { remove_obj $i; ((Q++)); OBJ+=("${scenario[$Q]}"); }
}

function intro {

	get_dimensions; Q=0

    scenario=( # Scenario 4 intro
	#----------+-------+-----+------------+----+
	# start X  |start Y|cuter|    end X   |type|
	#----------+-------+-----+------------+----+
	"$[$endx+1]   3       0   $[endx/2-34] piu"
	"$[$endx+1]   3       0   $[endx/2+2]  piu"
	"-2           12      0   $[endx/2-16] arr"
    "0            0       0   0            end"); OBJ=("${scenario[$Q]}")


	while true; do sleep 0.005; NO=${#OBJ[@]}; for (( i=0; i<$NO; i++ )); do
		OI=(${OBJ[$i]}); OX=${OI[0]}; OY=${OI[1]}; cuter=${OI[2]}; end=${OI[3]}; type=${OI[4]}

		case $type in
			#----------+---------------------+-------+-----+-----+-------+
			# OBJ type |        sprite       | func. |items|width|comment|
			#----------+---------------------+-------+-----+-----+-------+
			"arr" )		sprite=("${arr[@]}") ; right  $arrN $arrC;; #
			"piu" )		sprite=("${piu[@]}") ; left   $piuN $piuC;; #
			"end" )		                      return             ;; #

	esac; done; done
}

function configure {

  hero_color=(${BLK} ${RED} ${GRN} ${YLW} ${BLU} ${MGN} ${CYN} ${WHT}); HCN=${#hero_color[*]}; HCI=0;
  star_color=(${BLK} ${RED} ${GRN} ${YLW} ${BLU} ${MGN} ${CYN} ${WHT}); SCN=${#star_color[*]}; SCI=0;
   hero_star=(★ ☭ ✚ ✙ ✠ ✡ ✦ ✧ ✩ ✪ ☘ ☠ ☢ ☣ ☯ ❃ ❂ ❁ ✿ ❀ ✣ ♣ ♠ ♥ ♦ ❤ ● ☻ ♀ ♂); HSI=0; HSN=${#hero_star[*]}
        menu=( 'hero' 'star' 'symbol' 'apply' 'back' )                ; menuN=${#menu[*]};     menuI=$[$menuN-1]
        selL='>'; selR='<'; selN=' '

	function   back   { menu=( 'start' 'conf ' 'exit ' ); menuI=0; menuN=${#menu[*]}; }

	function deselect {
		selectedHCL=${selN}; selectedHCR=${selN}
		selectedSCL=${selN}; selectedSCR=${selN}
		selectedHSL=${selN}; selectedHSR=${selN}
		selectedAP=${DEF}  ; selectedBK=${DEF}; }

	while true; do get_dimensions

		hero=(${SKY}$HC'__        '${SKY}
              ${DIM}$HC"|${SKY}${SC}${HS}${HC}${BLD}〵${SKY}${HC}____  "${SKY}
              ${DIM}$HC" \_| ${BLD}${HC}/${DIM}${UND} °${SKY}${HC}${BLD})${blk}-${SKY}"
              ${DIM}$HC"   |${BLD}/     "${SKY}
                    $HC'          '${SKY})

		#-{ Get keys }-------------------------------------------------------------------------------------------------------
		read -t${spd} -n1 input 2> /dev/null; input=${input:0:1}; case $input in

			's'|'S') ((menuI++)); [ $menuI -gt $[$menuN-1] ] && menuI=$[$menuN-1];;
			'w'|'W') ((menuI--)); [ $menuI -lt 0           ] && menuI=0;;
			'd'|'D') case ${menu[$menuI]}	in	'hero'  ) ((HCI++)); [ $HCI -gt $[$HCN-1] ] && HCI=$[$HCN-1];;
												'star'  ) ((SCI++)); [ $SCI -gt $[$SCN-1] ] && SCI=$[$SCN-1];;
												'symbol') ((HSI++)); [ $HSI -gt $[$HSN-1] ] && HSI=$[$HSN-1];; esac;;

			'a'|'A')  case ${menu[$menuI]}	in	'hero'  ) ((HCI--)); [ $HCI -lt 0 ] && HCI=0;;
												'star'  ) ((SCI--)); [ $SCI -lt 0 ] && SCI=0;;
												'symbol') ((HSI--)); [ $HSI -lt 0 ] && HSI=0;; esac;;

			'p'|'P') case ${menu[$menuI]}	in	'hero'  ) HC=${hero_color[$HCI]};;
												'star'  ) SC=${star_color[$SCI]};;
												'symbol') HS=${hero_star[$HSI]} ;;
												'apply' )          back; clear; return;;
												'back'  ) default; back; clear; return;; esac;;
		esac

		#----------------------------------{ Print hero }----------------------------------
		for (( i=0; i<${#hero[@]}; i++ )); do XY $[$endx/2-4] $[5+$i] "${SKY} ${hero[$i]} "; done

		#----------------------------------{ Print controls }-------------------------------------------------------------
		for ((i=0; i<${HCN}; i++ )); do [ $i -eq $HCI ] && selectedHC=${BLD} || selectedHC=${DEF}
										XY $[$endx/2 - 4 + $i*3] $[$endy/2]   "$selectedHC${hero_color[$i]}██${DEF}"; done
		for ((i=0; i<${SCN}; i++ )); do [ $i -eq $SCI ] && selectedSC=${BLD} || selectedSC=${DEF}; SL=; SR=
										XY $[$endx/2 - 4 + $i*3] $[$endy/2+2] "$selectedSC${star_color[$i]}██${DEF}"; done
		for ((i=0; i<$[${HSN}/2]; i++ )); do [ $i -eq $HSI ] && selectedHS=${BLD}${RED} || selectedHS=${DEF}; SL=; SR=
										XY $[$endx/2 - 15 + $i*3] $[$endy/2+4] "$selectedHS${hero_star[$i]} ${DEF}" ; done
		for ((i=$[${HSN}/2]; i<${HSN}; i++ )); do [ $i -eq $HSI ] && selectedHS=${BLD}${RED} || selectedHS=${DEF}; SL=; SR=
										XY $[$endx/2 - 60 + $i*3] $[$endy/2+5] "$selectedHS${hero_star[$i]} ${DEF}" ; done

		case ${menu[$menuI]} in 'apply' )	deselect; selectedAP=${BLD}${RED};;
								'back'  )	deselect; selectedBK=${BLD}${RED};;
								'hero'  )	deselect; selectedHCL=${selL}; selectedHCR=${selR};;
								'star'  )	deselect; selectedSCL=${selL}; selectedSCR=${selR};;
								'symbol')	deselect; selectedHSL=${selL}; selectedHSR=${selR};;
								*       )	deselect;;esac

		XY $[$endx/2 - 18] $[$endy/2]   "${selectedHCL} Hero color: "  ; XY $[$endx/2 + 20] $[$endy/2]   "${selectedHCR}"
		XY $[$endx/2 - 20] $[$endy/2+2] "${selectedSCL} Symbol color: "; XY $[$endx/2 + 20] $[$endy/2+2] "${selectedSCR}"
		XY $[$endx/2 - 30] $[$endy/2+4] "${selectedHSL} Hero symbol: " ; XY $[$endx/2 + 30] $[$endy/2+4] "${selectedHSR}"

		XY $[$endx/2 - 2]  $[$endy/2+7] "${selectedAP}apply${DEF}"
		XY $[$endx/2 - 2]  $[$endy/2+9] "${selectedBK}back${DEF}"

	done

}

function main_menu {

	intro
	menu=( 'start' 'conf ' 'exit ' ); menuI=0; menuN=${#menu[*]}
	while true; do get_dimensions

		#-{ Get keys }-------------------------------------------------------------------------------------------------------
		read -t0.005 -n1 input 2> /dev/null; input=${input:0:1}; case $input in

			's'|'S') ((menuI++)); [[ $menuI -gt $[$menuN-1] ]] && menuI=$[$menuN-1];;
			'w'|'W') ((menuI--)); [[ $menuI -lt 0           ]] && menuI=0;;
			'd'|'D') menuI=$[$menuN-1];;
			'a'|'A') menuI=0;;
			'p'|'P') case ${menu[$menuI]}	in	'start') return;;
												'conf ') clear ;  configure && intro;;
												'exit ') bye   ;; esac;;
		esac

		for ((i=0; i<$menuN; i++)); do

			[[ $i -eq $menuI ]] && selected=${BLD}${RED} || selected=${DEF}
			XY $[$endx / 2 - ${#menu[$i]}] $[$endy - 5 + $i] " $selected${menu[$i]}${DEF} "

		done
	done
}

function fps_counter {

	#Needs bash 4.2
	printf -v cur_sec '%(%s)T\n' -1
	[[ $cur_sec -gt $sec ]] && {
		FPS=$FPSC
		[[ $FPS -gt $FPSM ]] && FPSM=$FPS
		[[ $FPS -lt $FPSL ]] && FPSL=$FPS
		sec=$cur_sec
		FPSC=0
	} || ((FPSC++))
}

function mover () { timer=$1

	# fly away
	[[ $OX -lt -$width ]] && { remove_obj $i; case $type in 'alien') ((enumber--));; esac; return; }

	# collisions with plane
	case  $type:"$HX $HY" in
		'alien':${target[0]}| 'alien':${target[1]}| 'alien':${target[2]}) erase_obj $i $hight; ((life--)); ((frags++)); ((enumber--)); OBJ+=("$OX $OY 0 boom"); return;;
		'gunup':${target[0]}| 'gunup':${target[1]}| 'gunup':${target[2]}) erase_obj $i $hight; [[ ${G} -lt 5 ]] && ((G++)); return;;
		 'ammo':${target[0]}|  'ammo':${target[1]}|  'ammo':${target[2]}) erase_obj $i $hight; ((ammo+=100)); return;;
		 'life':${target[0]}|  'life':${target[1]}|  'life':${target[2]}) erase_obj $i $hight; ((life++))   ; return;;
		'bfire':${target[0]}| 'bfire':${target[1]}| 'bfire':${target[2]}) erase_obj $i $hight; ((life--))   ; return;;
		 'boss':${target[0]}|  'boss':${target[1]}|  'boss':${target[2]}) ((life--)); ((bhealth-=10)); return;;
	esac

	# alien's collisions with pius
	case $type in 'alien'| 'boss')

		for (( t=0; t<${NP}; t++ )); do

			case "${PIU[$t]}" in # hit by bullet

				"${target[0]}"| "${target[1]}"| "${target[2]}")

					case $type in

						'alien') case $[RANDOM % $rnd] in 0)  OBJ+=("$OX $OY 0 ${bonuses[$[RANDOM % ${#bonuses[@]}]]}") ;; esac # get bonus
								 ((frags++));  ((enumber--)); erase_obj $i $hight; remove_piu $t; OBJ+=("$OX $OY 0 boom"); return;;

						'boss') remove_piu $t; ((bhealth--)); continue;;
						
					esac

			esac

		done
	esac

	# print
	[[ $cuter -lt $width ]] && cut_in
	[[    $OX -lt 1      ]] && cut_out
	printf "${sprite[*]}"

	# move
	case $timer in 0) ((OX--)); ((cuter++)); OBJ[$i]="$OX $OY $cuter $type";; esac
}

trap bye INT; trap : ALRM; stty -echo; printf "${COF}"; get_dimensions; default
clear; mess "help"; sleep 2; clear; main_menu; clear

#-{ Generate grass }-----------------------------------------------------------------------------------------------------
for ((i=0; i<$endx; i++)); do land+=${grass[$[RANDOM % ${#grass[*]}]]}; done; land+=$land; LN=${#land}

function fill_screen {
	#-{ Fill screen }----------------------------------------------------------------------------------------------------
	for ((i=0;         i<$lineendy; i++)); do printf "${SKY}%${endx}s"; done
	for ((i=$lineendy; i<$endy;     i++)); do printf "${LND}%${endx}s"; done
}; fill_screen; sec=$(date +'%s') # timer for FPS counter

#================================================{ Main game loop }======================================================
while true; do

	fps_counter

	# Hero collide coordinates
	HX=$(($X + 9)); HY=$(($Y + 3))

	#-{ Get keys }-------------------------------------------------------------------------------------------------------
	read -t${spd} -n1 input 2> /dev/null; input=${input:0:1}; case $input in

		'w'|'W')	[[ $Y    -gt 1         ]] && ((Y--));;
		'a'|'A')	[[ $X    -gt 1         ]] && ((X--));;
		's'|'S')	[[ $Y    -lt $heroendy ]] && ((Y++));;
		'd'|'D')	[[ $X    -lt $heroendx ]] && ((X++));;
		'p'|'P')	[[ $ammo -ge $G        ]] && { case ${G} in
						1) PIU+=("$HX $HY");;
						2) PIU+=("$HX $[$HY+1]" "$HX $[$HY-1]");;
						3) PIU+=("$HX $[$HY+1]" "$HX $[$HY-1]" "$[$HX+1] $HY");;
						4) PIU+=("$[$HX+1] $[$HY+1]" "$[$HX+1] $[$HY-1]" "$HX $[$HY+2]" "$HX $[$HY-2]");;
						5) PIU+=("$[$HX+1] $[$HY+1]" "$[$HX+1] $[$HY-1]" "$HX $[$HY+2]" "$HX $[$HY-2]" "$[$HX+2] $HY");;
					esac; ((ammo-=$G)); };;
	esac

	# Check win\lose
	[[ $bhealth -le 0 ]] && mess win
	[[ $life    -le 0 ]] && mess lose

	#-{ Timings }--------------------------------------------------------------------------------------------------------
	[[ $K -ge 20 ]] && K=0 || ((K++))	# boss' fire rate
	[[ $L -ge 3  ]] && L=0 || ((L++))	# sprites animation
	[[ $J -ge 5  ]] && J=0 || ((J++))	# boss' bullet animation
	[[ $Q -ge 6  ]] && Q=0 || ((Q++))	# tree1\cloud1(small)  speed
	[[ $W -ge 4  ]] && W=0 || ((W++))	# tree2\cloud2(medium) speed
	[[ $E -ge 2  ]] && E=0 || ((E++))	# tree3\cloud3(large)  speed
	[[ $E -eq 0  ]] && { ((S+=${SunC})); [[ $S -gt ${SunN} ]] && S=0; }	# Sun animation

	#-{ Print Sun }------------------------------------------------------------------------------------------------------
	sprite_Sun

	#-{ Move\check\print all flying to hero objects }--------------------------------------------------------------------
	NO=${#OBJ[@]}; for (( i=0; i<$NO; i++ )); do OI=(${OBJ[$i]}); OX=${OI[0]}; OY=${OI[1]}; cuter=${OI[2]}; type=${OI[3]}; case $type in

       #----------+---------------+------------+-----+----------+
       # OBJ type |  sprite maker |sprite mover|timer|  comment |
       #----------+---------------+------------+-----+----------+
		'tree1' )	sprite_tree1 ;    mover      $Q ;; #
		'tree2' )	sprite_tree2 ;    mover      $W ;; # Trees
		'tree3' )	sprite_tree3 ;    mover      $E ;; #

		'cloud1')	sprite_cloud1;    mover      $Q ;; #
		'cloud2')	sprite_cloud2;    mover      $W ;; # Clouds
		'cloud3')	sprite_cloud3;    mover      $E ;; #

		'alien' )	sprite_alien ;    mover       0 ;; # Aliens
		'boss'  )	sprite_boss  ;    mover       1 ;; # Boss

		'bfire' )	sprite_bfire ;    mover       0 ;; # Boss' plasma shot

		'ammo'  )	sprite_ammob ;    mover       0 ;; # Ammo bonus
		'life'  )	sprite_lifep ;    mover       0 ;; # Life bonus
		'gunup' )	sprite_gunup ;    mover       0 ;; # Gun powerup bonus

        # Enemy explosions, not moving, print in place
		'boom'  )	sprite_boom;;

	esac; done

	#-{ BOSS }-----------------------------------------------------------------------------------------------------------
	[[ $frags -ge $tillboss ]] && {

		# add boss object
		[[ $bossborn ]] || { OBJ+=("$BX $BY 0 boss"); bossborn=true; }

		# Health bar
		bar=; hp=$[$bosshbar * $bhealth / 100]; hm=$[$endx - 10]
		for (( i=0  ; i<${hp}; i++ )); do bar="█${bar}"; done
		for (( i=$hp; i<${hm}; i++ )); do bar="${bar} "; done
		XY 1 $[$endy - 1] "${LND} ${BLD}${RED}BOSS: ${LND}${BLK}|${BLD}${RED}${bar}${LND}${BLK}|${LND}"

		# Add enemy
		[[ $enumber -lt $enmax && $J -eq 0 ]] && { ((enumber++)); OBJ+=("$EX $EY 0 alien"); }
	} || {
		[[ $enumber -lt $enmax && $J -eq 0 ]] && { ((enumber++)); OBJ+=("$[$endx + 1] $[RANDOM % $enmyendy + 3] 0 alien"); }
	}

	#-{ Move\check\print hero bullets }----------------------------------------------------------------------------------
	NP=${#PIU[@]}; for (( t=0; t<${NP}; t++ )); do PI=(${PIU[$t]}); PX=${PI[0]}; PY=${PI[1]}

		# Move
		((PX++))

		# Fly away
		[[ $PX -ge $bullendx ]] && { remove_piu ${t}; continue; } || { PIU[$t]="$PX $PY"; }

		# print
		XY $PX $PY "$SKY ${shoot[$L]}"

		# Hit boss
		[[ $frags -ge $tillboss ]] && for (( p=2; p<5; p++ )); do case "$PX $PY" in

			"$BX $[$BY + $p]"|"$[$BX + 1] $[$BY + $p]") ((bhealth--)); remove_piu ${t};;

		esac; done

	done

	case $background in true)
		#-{ Add cloud }--------------------------------------------------------------------------------------------------
		case $[RANDOM % $CLD] in 0) OBJ+=("$[$endx + 1] $[RANDOM % 10 + 2] 0 cloud$[RANDOM % 3 + 1]");; esac

		#-{ Add tree }---------------------------------------------------------------------------------------------------
		case $[RANDOM % $TRE]:$[RANDOM % 3 + 1] in
		    0:1) OBJ+=("$[$endx + 1] ${tre1endy} 0 tree1");;
		    0:2) OBJ+=("$[$endx + 1] ${tre2endy} 0 tree2");;
		    0:3) OBJ+=("$[$endx + 1] ${tre3endy} 0 tree3");;
		esac;;
	esac

	#-{ Print hero }-----------------------------------------------------------------------------------------------------
	sprite_hero

	#-{ Print moving land }----------------------------------------------------------------------------------------------
	XY 1 $lineendy "${LND}${land:$[1-$LX]:$endx}"; [ $LX -lt  -$[$LN/2]  ] && LX=-1 || ((LX--)); XY 1 $endy "${LND}%${endx}s"

	#-{ Print game status }----------------------------------------------------------------------------------------------
	XY 2 0     "$SKY${BLK}killed aliens: $SKY$RED$frags$SKY  ${BLK}Life: $SKY$RED$life$SKY  ${BLK}Ammo: $SKY$RED$ammo$SKY "
	XY 2 $endy "$LND${BLK}FPS: $RED$FPS ${BLK}FPS max: $RED$FPSM ${BLK}FPS low: $RED$FPSL "

done

# vim: ts=4
